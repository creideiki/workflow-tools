#! /bin/bash

usage()
{
    cat <<EOF >&2
usage: $(basename $0) <command> <github-fork>:<branch> <pullrequest#>

GitHub pull request helper.

Assumptions: upstream/master is the master branch of the upsteam
repository

Commands:

list:   List open pull requests in the upstream repository.

pull:   Pulls forked branch into local branch of upstream/master, and
        leaves it in a non-committed state for inspection and testing.

commit: Commits merge with a GPG signed constructed commit message.

push:   Pushes to "upstream master" and cleans up temporary branch.

reset:  Resets working copy to local master and deletes the temporary
        pull request branch.

WARNING: No github API validation of the PR is done.
EOF
    exit 1
}

github-list()
{
    local org repo
    org=$(git remote get-url upstream | cut -d: -f2 | cut -d/ -f1)
    repo=$(basename $(git remote get-url upstream | cut -d: -f2 | cut -d/ -f2) .git)
    curl --silent https://api.github.com/repos/$org/$repo/pulls | \
        jq -r \
           '.[] |
            @text "\(.number) (\(.head.label)): \(.title)"'
}

parse-command-line()
{
    [ $# = 3 ] || usage

    topdir=$(git rev-parse --show-toplevel)
    upstream_url=$(git remote get-url upstream)
    project=$(basename $upstream_url .git)
    source=$(<<< "$2" cut -d: -f1 --only-delimited)
    branch=$(<<< "$2" cut -d: -f2 --only-delimited)
    [ -z "$source" -o -z "$branch" ] && usage
    source_url=https://github.com/$source/$project
    preq=$3
    msgfile="$topdir/.git/PULL_REQUEST_EDITMSG"
}

github-pull()
{
    parse-command-line "$@"

    local merge_base merge_head

    git checkout -b ${source}-${branch} upstream/master || return
    git pull --ff-only || return
    git pull --no-ff --verify-signatures --no-commit "$source_url" "$branch" || return
    merge_base=$(cat "$topdir/.git/ORIG_HEAD")
    merge_head=$(cat "$topdir/.git/MERGE_HEAD")

    cat <<EOF >$msgfile
Merge pull request #$preq from $source/$branch

EOF
    git log --pretty='* %h %s' $merge_base..$merge_head >>$msgfile
}

github-commit()
{
    parse-command-line "$@"

    git commit -S -e -F $msgfile || return
}

github-push()
{
    parse-command-line "$@"

    git push upstream HEAD:master && rm $msgfile
    git checkout master
    git branch -d ${source}-${branch}
}

github-reset()
{
    parse-command-line "$@"

    git reset --hard
    git checkout master
    git branch -D ${source}-${branch}
}

case "$1" in
    list|pull|commit|push|reset)
        eval github-$1 "$@" ;;
    *)
        usage ;;
esac
